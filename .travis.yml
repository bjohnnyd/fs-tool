branches:
  only:
  - master

os:
  - linux
  - osx
  - windows
language: rust

rust:
  - stable
  - beta
  - nightly

jobs:
  allow_failures:
    - rust: nightly
  fast_finish: true
cache: cargo

before_cache:
  - rm -rf "$TRAVIS_HOME/.cargo/registry/src"

script:
  - cargo test --verbose --all
  - cargo build --release --verbose --all
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then choco install zip && RELEASE_OS="x86_64-pc-windows-gnu"; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then RELEASE_OS="x86_64-apple-darwin"; fi                                                                                                                      
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then RELEASE_OS="x86_64-unknown-linux-gnu"; fi
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then $BUILD_FILE="/target/release/fs-tool.exe"; else $BUILD_FILE="/target/release/fs-tool"; fi
  - export TAR=$RELEASE_OS.tar.gz && export ZIP=$RELEASE_OS.zip
  - tar cvzf $TAR $BUILD_FILE
  - zip $ZIP $BUILD_FILE
  - ls *

before_deploy:
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then choco install zip && RELEASE_OS="x86_64-pc-windows-gnu"; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then RELEASE_OS="x86_64-apple-darwin"; fi                                                                                                                      
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then RELEASE_OS="x86_64-unknown-linux-gnu"; fi
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then $BUILD_FILE="/target/release/fs-tool.exe"; else $BUILD_FILE="/target/release/fs-tool"; fi
  - export TAR=$RELEASE_OS.tar.gz && export ZIP=$RELEASE_OS.zip
  - tar cvzf $TAR $BUILD_FILE
  - zip $ZIP $BUILD_FILE

deploy:
  provider: releases
  api_key:
    secure: pTp1GveByknwXupSWQ5jMLzYjb4n/mfLdLD3HhEQrOvFv9KwG+eFjbxfF3SowXgacyZ/brU4Lh1QiYLnxf9LZlUUgouIbB9j/ZIe2bs+byQ/7zQ1gC0v273iqrOP23hoZFZkSypkW+Ysjb2GmoqdVdJd+Vq0MhzLq6SISgILIhQ64mmLQmjl2tmNOEa7zWIhSVRa5XW1tRwt4mOfWh7sK/Up/8gWCmkaYPDT2JjSi1KCpkr4t3/+ISZQCjtlhidkQntoyfrIiT+HPmvwwHGbSITxRBHqHnkfgmb0lTvErg3FW6pyFn0UTyjxWsEIodSBxvT3ibYtnEQk5lWWTqmWjRzWsVpdWlaUV6ffCucSM0tb+HvJTwJisc1VAcGNfxloNR3ER4nu7lAfikrLOu4oHHKhegfeEukQgSXwiCXAi5d8qO1dpmH/OAhPLw2qYfvVOuITxx6zK1LN2HcK+KWNG8xie+uElWDKFhgpw9d6z02Pz8yqPdvuCJKcftgDulEW962duYOU4uazCoAFm9p/48PA87eqHg3HjLG4KUr1HJixoBeZBIX/jncp85PjTTLzMhOv4fD0asAVdwIVic/vEw/ilYFjxgxl1VpYxVzTOsOCxm6VBPy9jYMwIR8TCXhed5IuPutV5HMTswxrwgwgRrl4+QdBNnp2v1gV/h0F7wQ=
  file: 
    - "$TAR"
    - "$ZIP"
  on:
    tags: true
    repo: bjohnnyd/fs-tool
  skip_cleanup: 'true'
